{"version":3,"sources":["plugins/new-notice.js"],"names":["defaultMsg","name","NewNotice","weight","type","default","shortInfo","info","go","body","event","groupId","gourp_id","userId","user_id","logger","memberName","QQService","getGroupMemberName","template","getTemplate","msg","convertMsg","sendGroupMessage","replace","createTable","trx","schema","hasTable","table","bigInteger","primary","string","result","first","select","where","withTransaction"],"mappings":"iOAAA;AACA;AACA;AACA,iE;;AAEA,MAAMA,UAAU,GAAGC,IAAI,IAAK,MAAKA,IAAK,0BAAtC,C;;;;;;;;;;AAUMC,S,WARL,oBAAO,EACND,IAAI,EAAE,YADA,EAENE,MAAM,EAAE,EAFF,EAGNC,IAAI,EAAE,QAHA,EAINC,OAAO,EAAE,IAJH,EAKNC,SAAS,EAAE,MALL,EAMNC,IAAI,EAAE,MANA,EAAP,C,2BAAD,MAQML,SARN,CAQgB;AACRM,EAAAA,EAAN,CAASC,IAAT,EAAe;AACLC,MAAAA,KADK,GACyCD,IADzC,CACLC,KADK,CACYC,OADZ,GACyCF,IADzC,CACEG,QADF,CAC8BC,MAD9B,GACyCJ,IADzC,CACqBK,OADrB;AAEb,UAAIJ,KAAK,KAAK,gBAAd,EAAgC,OAAO,OAAP;AAChCK,sBAAOR,IAAP,CAAa,KAAII,OAAQ,SAAQE,MAAO,gBAAxC;AACA,YAAMG,UAAU,SAASC,mBAAUC,kBAAV,CAA6BP,OAA7B,EAAsCE,MAAtC,CAAzB;AACA,UAAI,CAACG,UAAL,EAAiB,OAAO,OAAP;AACjB,YAAMG,QAAQ,SAAS,KAAI,CAACC,WAAL,CAAiBT,OAAjB,CAAvB;AACA,UAAIU,GAAJ;AACA,UAAIF,QAAJ,EAAc;AACZE,QAAAA,GAAG,GAAG,KAAI,CAACC,UAAL,CAAgBH,QAAhB,EAA0BH,UAA1B,CAAN;AACD,OAFD,MAEO;AACLK,QAAAA,GAAG,GAAGrB,UAAU,CAACgB,UAAD,CAAhB;AACD;AACDD,sBAAOR,IAAP,CAAa,IAAGM,MAAO,KAAIG,UAAW,eAAcK,GAAI,EAAxD;AACAJ,yBAAUM,gBAAV,CAA2BZ,OAA3B,EAAoCU,GAApC;AACA,aAAO,IAAP,CAfa;AAgBd;;AAEDC,EAAAA,UAAU,CAACD,GAAD,EAAML,UAAN,EAAkB;AAC1B;AACA,WAAOK,GAAG,CAACG,OAAJ,CAAY,SAAZ,EAAuBR,UAAvB,CAAP;AACD;;;AAGKS,EAAAA,WADN,CACkBC,GADlB,EACuB;AACrB,UAAI,QAAQA,GAAG,CAACC,MAAJ,CAAWC,QAAX,CAAoB,YAApB,CAAR,CAAJ,EAAgD;AAC9C,cAAMF,GAAG,CAACC,MAAJ,CAAWF,WAAX,CAAuB,YAAvB,EAAsCI,KAAD,IAAW;AACpDA,UAAAA,KAAK,CAACC,UAAN,CAAiB,UAAjB,EAA6BC,OAA7B;AACAF,UAAAA,KAAK,CAACG,MAAN,CAAa,UAAb;AACD,SAHK,CAAN;AAID,OANoB;AAOtB;;;AAGKZ,EAAAA,WADN,CACkBM,GADlB,EACuBf,OADvB,EACgC;AAC9B,YAAMsB,MAAM,SAASP,GAAG,CAAC,YAAD,CAAH;AAClBQ,MAAAA,KADkB;AAElBC,MAAAA,MAFkB,CAEX,UAFW;AAGlBC,MAAAA,KAHkB,CAGZ,UAHY,EAGAzB,OAHA,CAArB;AAIA,aAAO,CAACsB,MAAM,IAAI,EAAX,EAAed,QAAtB,CAL8B;AAM/B,GAzCa,C,gEAwBbkB,mB,uJAUAA,mB;;;AAUYnC,S","sourcesContent":["import { withTransaction } from '../decorators/db';\nimport { Plugin } from '../decorators/plugin';\nimport QQService from '../services/qq-service';\nimport logger from '../utils/logger';\n\nconst defaultMsg = name => `欢迎 ${name} 加入本群! 请使用\"!help\"查看可用指令~`;\n\n@Plugin({\n  name: 'new-notice',\n  weight: 99,\n  type: 'notice',\n  default: true,\n  shortInfo: '入群提醒',\n  info: '入群提醒'\n})\nclass NewNotice {\n  async go(body) {\n    const { event, gourp_id: groupId, user_id: userId } = body;\n    if (event !== 'group_increase') return 'break';\n    logger.info(`群 ${groupId} 有新成员 ${userId} 加入, 正在查询昵称...`);\n    const memberName = await QQService.getGroupMemberName(groupId, userId);\n    if (!memberName) return 'break';\n    const template = await this.getTemplate(groupId);\n    let msg;\n    if (template) {\n      msg = this.convertMsg(template, memberName);\n    } else {\n      msg = defaultMsg(memberName);\n    }\n    logger.info(`向${userId}: ${memberName}, 发送欢迎入群消息: ${msg}`);\n    QQService.sendGroupMessage(groupId, msg);\n    return true;\n  }\n\n  convertMsg(msg, memberName) {\n    // eslint-disable-next-line no-template-curly-in-string\n    return msg.replace('${name}', memberName);\n  }\n\n  @withTransaction\n  async createTable(trx) {\n    if (!(await trx.schema.hasTable('new-notice'))) {\n      await trx.schema.createTable('new-notice', (table) => {\n        table.bigInteger('group_id').primary();\n        table.string('template');\n      });\n    }\n  }\n\n  @withTransaction\n  async getTemplate(trx, groupId) {\n    const result = await trx('new-notice')\n      .first()\n      .select('template')\n      .where('group_id', groupId);\n    return (result || {}).template;\n  }\n}\n\nexport default NewNotice;\n"],"file":"new-notice.js","sourceRoot":"/Users/zcwsr/my/japari-admin/src"}