{"version":3,"sources":["plugins/commands/new-member-notice.js"],"names":["DEFAULT_TPL","NewNotice","name","command","type","info","default","level","getValue","params","match","key","value","getTemplate","trx","groupId","result","first","select","where","template","setTemplate","exist","group_id","update","insert","run","body","trim","QQService","sendGroupMessage","withTransaction"],"mappings":"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","sourcesContent":["import { Command } from '../../decorators/plugin';\nimport { withTransaction } from '../../decorators/db';\nimport QQService from '../../services/qq-service';\n\n// eslint-disable-next-line no-template-curly-in-string\nconst DEFAULT_TPL = '欢迎 ${name} 加入本群! 请使用\"!help\"查看可用指令~';\n\n@Command({\n  name: '配置入群提醒模板',\n  command: 'newNotice',\n  type: 'group',\n  info:\n  // eslint-disable-next-line no-template-curly-in-string\n    \"查看当前或设置当前群的入群提醒模板, '!newNotice'来查看, '!newNotice set xxx'来设置, 模板中可使用'${name}'来代替入群人昵称\",\n  default: true,\n  level: 2\n})\nclass NewNotice {\n  getValue(params) {\n    const match = params.match(/^(\\w+)\\s(.*)/);\n    if (!match) {\n      return {\n        key: match,\n        value: null\n      };\n    }\n    return {\n      key: match[1],\n      value: match[2]\n    };\n  }\n\n  @withTransaction\n  async getTemplate(trx, groupId) {\n    const result = await trx('new-notice')\n      .first()\n      .select('template')\n      .where('group_id', groupId);\n    return (result || {}).template;\n  }\n\n  @withTransaction\n  async setTemplate(trx, groupId, template) {\n    const exist = !!(await trx('new-notice')\n      .where({ group_id: groupId })\n      .first());\n    if (exist) {\n      await trx('new-notice')\n        .update({ template })\n        .where('group_id', groupId);\n    } else {\n      await trx('new-notice').insert({ template, group_id: groupId });\n    }\n  }\n\n  async run(params, body) {\n    const { group_id: groupId } = body;\n    params = params.trim();\n    const template = await this.getTemplate(groupId);\n    if (!params) {\n      if (template) {\n        QQService.sendGroupMessage(groupId, `当前模板内容:\\n'${template}'`);\n      } else {\n        QQService.sendGroupMessage(groupId, `未设置自定义模板, 以下为默认模板:\\n'${DEFAULT_TPL}'`);\n      }\n      return;\n    }\n    const { key, value } = this.getValue(params);\n    if (key !== 'set') {\n      QQService.sendGroupMessage(groupId, `非法参数'${key || 'null'}'`);\n      return;\n    }\n    if (!value) {\n      QQService.sendGroupMessage(groupId, '不可设置空模板');\n      return;\n    }\n    await this.setTemplate(groupId, value);\n    QQService.sendGroupMessage(groupId, '设置成功!');\n  }\n}\n\nexport default NewNotice;\n"],"file":"new-member-notice.js","sourceRoot":"/Users/zcwsr/my/japari-admin/src"}