{"version":3,"sources":["plugins/commands/plugin.js"],"names":["PluginConfig","name","command","type","info","default","level","getAllPlugins","PluginService","plugins","group","notice","run","params","body","groupId","group_id","isAdmin","Config","ADMINS","indexOf","user_id","allPluginList","configMap","getGroupConfig","content","reduce","result","current","index","hasThisPlugin","hide","shortInfo","slice","length","QQService","sendGroupMessage","replace","trim","toggleIndexs","split","configMapClone","alertMsg","every","plugin","currentIndex","setGroupConfig"],"mappings":"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","sourcesContent":["import { Command } from '../../decorators/plugin';\nimport Config from '../../config';\nimport PluginService from '../../services/plugin-service';\nimport QQService from '../../services/qq-service';\n\n@Command({\n  name: '插件配置',\n  command: 'plugin',\n  type: 'group',\n  info:\n    \"用来配置插件开启状态, '!plugin' 来查看开启状态, '!plugin x x' 来切换开启/关闭状态, x为插件编号, 用空格分割\",\n  default: true,\n  level: 2\n})\nclass PluginConfig {\n  getAllPlugins() {\n    const { group, notice } = PluginService.plugins;\n    return [...group, ...notice];\n  }\n\n  async run(params, body) {\n    const { group_id: groupId } = body;\n    const isAdmin = Config.ADMINS.indexOf(+body.user_id) > -1;\n    const allPluginList = this.getAllPlugins();\n    const configMap = PluginService.getGroupConfig(groupId);\n    if (!params) {\n      let content = allPluginList.reduce((result, current, index) => {\n        const hasThisPlugin = configMap[current.name];\n        if (current.hide && !isAdmin) {\n          return result;\n        }\n        result += `${index + 1}. ${current.shortInfo}${hasThisPlugin ? '(开启中)' : '(关闭)'}\\n`;\n        return result;\n      }, '插件开启状态:\\n');\n      content = content.slice(0, content.length - 1);\n      QQService.sendGroupMessage(groupId, content);\n      return;\n    }\n    if (params.replace(/\\d/g, '').trim()) {\n      QQService.sendGroupMessage(groupId, '非法参数');\n    }\n    const toggleIndexs = params.trim().split(' ');\n    const configMapClone = { ...configMap };\n    let alertMsg = '';\n    allPluginList.every((plugin, index) => {\n      const currentIndex = index + 1;\n      if (toggleIndexs.indexOf(`${currentIndex}`) === -1) {\n        return true;\n      }\n      if (!isAdmin && plugin.hide) {\n        alertMsg = `别试了, ${currentIndex} 你没权限操作`;\n        return false;\n      }\n      const hasThisPlugin = configMapClone[plugin.name];\n      if (hasThisPlugin) {\n        delete configMapClone[plugin.name];\n      } else {\n        configMapClone[plugin.name] = true;\n      }\n      return true;\n    });\n    if (alertMsg) {\n      QQService.sendGroupMessage(groupId, alertMsg);\n      return;\n    }\n    await PluginService.setGroupConfig(groupId, configMapClone);\n    await QQService.sendGroupMessage(groupId, '设置成功');\n    await this.run('', body);\n  }\n}\n\nexport default PluginConfig;\n"],"file":"plugin.js","sourceRoot":"/Users/zcwsr/my/japari-admin/src"}