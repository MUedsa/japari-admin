{"version":3,"sources":["decorators/plugin.js"],"names":["Plugin","config","defaultConfig","name","weight","type","shortInfo","info","default","hide","mute","target","constructor","Object","keys","forEach","configName","go","body","plugins","logger","prototype","call","setDBInstance","instance","DBInstance","Block","descriptor","fn","value","args","Command","command","level","permissionDeniedNotice","sendNoPermissionMsg","group_id","groupId","user_id","userId","QQService","sendGroupMessage","sendPrivateMessage","trigger","params","commandMap","Config","ADMINS","indexOf","userRole","getGroupUserRole","run"],"mappings":"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","sourcesContent":["import Config from '../config';\nimport logger from '../utils/logger';\nimport QQService from '../services/qq-service';\n\nexport const Plugin = (config) => {\n  const defaultConfig = {\n    name: '', // 插件名, 只可为英文名\n    weight: 0, // 权重\n    type: 'group', //  所属消息类别\n    shortInfo: '', // 短描述\n    info: '', // 插件描述\n    default: false, // 默认加载, 可被群配置覆盖,\n    hide: false, // 是否在\n    mute: false // 不打印命中log\n  };\n\n  if (typeof config === 'string') {\n    config = { ...defaultConfig, name: config };\n  } else if (typeof config === 'object') {\n    config = { ...defaultConfig, ...config };\n  }\n  return target => class extends target {\n    constructor() {\n      super();\n      Object.keys(config).forEach((configName) => {\n        this[configName] = config[configName];\n      });\n    }\n\n    go(body, plugins) {\n      this.mute || logger.info(`plugin ${this.name} triggered`);\n      return target.prototype.go.call(this, body, plugins);\n    }\n\n    setDBInstance(instance) {\n      this.DBInstance = instance;\n    }\n  };\n};\n\nexport const Block = (target, name, descriptor) => {\n  const fn = descriptor.value;\n  // eslint-disable-next-line space-before-function-paren\n  descriptor.value = async function value(...args) {\n    return (await fn.call(this, ...args)) || true;\n  };\n  return descriptor;\n};\n\nexport const Command = (config) => {\n  const defaultConfig = {\n    name: '', // 指令中文简称\n    command: '', // 指令英文名, 调用时使用\n    type: 'all', // 指令类型, all group private\n    info: '描述', // 指令详细描述\n    default: false, // 是否默认开启\n    mute: false, // 不打印命中log\n    level: 1, // 权限级别, 1 普通, 2 管理员, 3 总管理,\n    permissionDeniedNotice: '权限不足' // 权限不足提醒文案\n    // groupPermissionDeniedNotice: '', // 群权限不足提醒文案,\n    // privatePermissionDeniedNotice: '' // 私聊权限不足提醒文案\n  };\n\n  if (typeof config === 'string') {\n    config = { ...defaultConfig, name: config, command: config };\n  } else if (typeof config === 'object') {\n    config = { ...defaultConfig, ...config };\n  }\n  if (config.type === 'private' && config.level < 3) {\n    config.level = 1;\n  }\n  return target => class extends target {\n    constructor() {\n      super();\n      Object.keys(config).forEach((configName) => {\n        this[configName] = config[configName];\n      });\n    }\n\n    sendNoPermissionMsg({ group_id: groupId, user_id: userId }, type) {\n      if (type === 'group') {\n        QQService.sendGroupMessage(groupId, this.permissionDeniedNotice);\n        return;\n      }\n      if (type === 'private') {\n        QQService.sendPrivateMessage(userId, this.permissionDeniedNotice);\n      }\n    }\n\n    async trigger(params, body, type, commandMap) {\n      this.mute || logger.info(`command '!${this.command}' triggered, params: ${params}`);\n      if (this.level === 3) {\n        if (Config.ADMINS.indexOf(+body.user_id) === -1) {\n          this.sendNoPermissionMsg(body, type);\n          return;\n        }\n      } else if (this.level === 2) {\n        // 只有群聊模式才会出现level=2\n        const userRole = await QQService.getGroupUserRole(body.group_id, body.user_id);\n        if (!(userRole === 'owner' || userRole === 'admin')) {\n          QQService.sendGroupMessage(body.group_id, this.permissionDeniedNotice);\n          return;\n        }\n      }\n      return target.prototype.run.call(this, params, body, type, commandMap);\n    }\n\n    setDBInstance(instance) {\n      this.DBInstance = instance;\n    }\n  };\n};\n"],"file":"plugin.js","sourceRoot":"/Users/zcwsr/my/japari-admin/src"}